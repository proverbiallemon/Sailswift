name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Set Version in Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" Sailswift/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" Sailswift/Info.plist
          echo "Version set to: ${{ steps.version.outputs.version }} (${{ github.run_number }})"

      - name: Build Release
        run: |
          xcodebuild -project Sailswift.xcodeproj \
            -scheme Sailswift \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            build

      - name: Re-sign Frameworks and App
        run: |
          APP_PATH="build/Build/Products/Release/Sailswift.app"

          # Re-sign Sparkle framework with ad-hoc signature
          codesign --force --deep --sign - "$APP_PATH/Contents/Frameworks/Sparkle.framework"

          # Re-sign the main app
          codesign --force --deep --sign - "$APP_PATH"

          # Verify
          codesign --verify --deep --strict "$APP_PATH"

      - name: Create ZIP Archive
        run: |
          cd build/Build/Products/Release
          zip -r -y ../../../../Sailswift-${{ steps.version.outputs.version }}.zip Sailswift.app

      - name: Download Sparkle
        run: |
          curl -LO https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
          tar -xf Sparkle-2.6.4.tar.xz
          ls -la bin/

      - name: Sign Update with EdDSA
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Write private key to temp file
          echo "$SPARKLE_PRIVATE_KEY" > sparkle_private_key.pem

          # Get file size
          FILE_SIZE=$(stat -f%z "Sailswift-${{ steps.version.outputs.version }}.zip")

          # Sign the update (tools extract to bin/ not Sparkle-2.6.4/bin/)
          # sign_update outputs: sparkle:edSignature="..." length="..."
          # Extract just the base64 signature value
          SIGN_OUTPUT=$(./bin/sign_update "Sailswift-${{ steps.version.outputs.version }}.zip" -f sparkle_private_key.pem)
          SIGNATURE=$(echo "$SIGN_OUTPUT" | sed -n 's/.*edSignature="\([^"]*\)".*/\1/p')

          # Clean up private key
          rm sparkle_private_key.pem

          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          echo "Signature: $SIGNATURE"
          echo "File size: $FILE_SIZE"

      - name: Update Appcast
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_NUMBER="${{ github.run_number }}"
          SIGNATURE="${{ steps.sign.outputs.signature }}"
          FILE_SIZE="${{ steps.sign.outputs.file_size }}"
          DATE=$(date -R)
          DOWNLOAD_URL="https://github.com/proverbiallemon/Sailswift/releases/download/v${VERSION}/Sailswift-${VERSION}.zip"

          # Create updated appcast with new item
          # sparkle:version uses build number for reliable comparison
          # sparkle:shortVersionString is the display version
          cat > appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
              <channel>
                  <title>Sailswift Updates</title>
                  <link>https://github.com/proverbiallemon/Sailswift</link>
                  <description>Sailswift update feed</description>
                  <language>en</language>
                  <item>
                      <title>Version ${VERSION}</title>
                      <pubDate>${DATE}</pubDate>
                      <sparkle:version>${BUILD_NUMBER}</sparkle:version>
                      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                      <sparkle:minimumSystemVersion>13.0</sparkle:minimumSystemVersion>
                      <enclosure url="${DOWNLOAD_URL}"
                                 sparkle:edSignature="${SIGNATURE}"
                                 length="${FILE_SIZE}"
                                 type="application/octet-stream" />
                  </item>
              </channel>
          </rss>
          EOF

          echo "Updated appcast.xml:"
          cat appcast.xml

      - name: Commit Appcast Update
        run: |
          # Save the generated appcast
          cp appcast.xml /tmp/appcast.xml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout -f main

          # Restore the generated appcast
          cp /tmp/appcast.xml appcast.xml

          git add appcast.xml
          git commit -m "Update appcast for v${{ steps.version.outputs.version }}"
          git push origin main

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Sailswift v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          files: |
            Sailswift-${{ steps.version.outputs.version }}.zip
          body: |
            ## Sailswift v${{ steps.version.outputs.version }}

            ### Installation
            1. Download `Sailswift-${{ steps.version.outputs.version }}.zip`
            2. Extract and drag `Sailswift.app` to your Applications folder
            3. If you see a security warning, right-click and select "Open"

            ### Auto-Update
            If you already have Sailswift installed, it will automatically check for updates.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
